FROM docker.m.daocloud.io/library/node:22-bookworm

ARG AICODEWITH_API_KEY
ENV AICODEWITH_API_KEY=${AICODEWITH_API_KEY}

WORKDIR /app

# Install pnpm
RUN corepack enable && corepack prepare pnpm@latest --activate

# Copy plugin source
COPY . /plugin

WORKDIR /plugin

# Install dependencies
RUN pnpm install --frozen-lockfile 2>/dev/null || npm install

# Run unit tests first
RUN echo "=== Running Unit Tests ===" && (pnpm test 2>/dev/null || npm test 2>/dev/null || echo "Skipping tests")

WORKDIR /app

# Install OpenClaw CLI globally
RUN npm install -g openclaw@latest

# Create comprehensive test script
RUN cat > /app/run-e2e-tests.sh << 'SCRIPT'
#!/usr/bin/env bash
set -euo pipefail

echo "========================================"
echo "OpenClaw AICodewith Auth Plugin E2E Tests"
echo "========================================"
echo ""

# Create isolated test environment
TEST_HOME=$(mktemp -d "/tmp/openclaw-e2e.XXXXXX")
export HOME="$TEST_HOME"
echo "Test HOME: $TEST_HOME"

# ========================================
# Test 1: Plugin Installation & Migration
# ========================================
echo ""
echo "=== Test 1: Plugin Installation & Config Migration ==="
mkdir -p "$HOME/.openclaw"

# Create initial config with deprecated models
cat > "$HOME/.openclaw/openclaw.json" << 'CONFIG'
{
  "agents": {
    "defaults": {
      "model": {
        "primary": "aicodewith-claude/claude-opus-4-5-20251101",
        "fallbacks": ["aicodewith-gpt/gpt-5.2-codex"]
      }
    },
    "list": [
      {
        "id": "test-agent",
        "model": {
          "primary": "aicodewith-claude/claude-sonnet-4-5-20250929-third-party"
        }
      }
    ]
  }
}
CONFIG

echo "Initial config with deprecated models:"
cat "$HOME/.openclaw/openclaw.json"
echo ""

# Install plugin
if openclaw plugins install file:/plugin 2>&1; then
  echo "✓ Plugin installed successfully"
else
  echo "✗ Plugin installation failed"
  exit 1
fi

# ========================================
# Test 2: Plugin Loading & Provider Registration
# ========================================
echo ""
echo "=== Test 2: Plugin Loading ==="
openclaw plugins list --json > /tmp/plugins.json 2>/dev/null || true

node - << 'NODE'
const fs = require("node:fs");

try {
  const data = JSON.parse(fs.readFileSync("/tmp/plugins.json", "utf8"));
  const plugin = (data.plugins || []).find((entry) => 
    entry.id === "openclaw-aicodewith-auth" || 
    entry.name?.includes("AICodewith")
  );
  
  if (!plugin) {
    console.log("✗ Plugin not found in list");
    process.exit(1);
  }
  
  if (plugin.status !== "loaded") {
    console.log(`✗ Plugin status is ${plugin.status}, expected loaded`);
    process.exit(1);
  }
  
  console.log(`✓ Plugin loaded: ${plugin.id} v${plugin.version}`);
  
  // Verify providers registered
  const expectedProviders = ["aicodewith-gpt", "aicodewith-claude", "aicodewith-gemini"];
  const registeredProviders = plugin.providerIds || [];
  const missingProviders = expectedProviders.filter(p => !registeredProviders.includes(p));
  
  if (missingProviders.length > 0) {
    console.log(`✗ Missing providers: ${missingProviders.join(", ")}`);
    process.exit(1);
  }
  
  console.log(`✓ All providers registered: ${registeredProviders.join(", ")}`);
  
} catch (err) {
  console.log(`✗ Error parsing plugins: ${err.message}`);
  process.exit(1);
}
NODE

# ========================================
# Test 3: Config Migration Verification
# ========================================
echo ""
echo "=== Test 3: Config Migration ==="

node - << 'NODE'
const fs = require("node:fs");

const config = JSON.parse(fs.readFileSync(process.env.HOME + "/.openclaw/openclaw.json", "utf8"));

let allPassed = true;

// Check defaults.model.primary
const defaultModel = config.agents?.defaults?.model;
if (defaultModel?.primary === "aicodewith-claude/claude-opus-4-6-20260205") {
  console.log("✓ defaults.model.primary migrated to claude-opus-4-6-20260205");
} else {
  console.log(`✗ defaults.model.primary is ${defaultModel?.primary}, expected claude-opus-4-6-20260205`);
  allPassed = false;
}

// Check defaults.model.fallbacks
const fallbacks = defaultModel?.fallbacks || [];
if (fallbacks.includes("aicodewith-gpt/gpt-5.3-codex")) {
  console.log("✓ defaults.model.fallbacks migrated to gpt-5.3-codex");
} else {
  console.log(`✗ defaults.model.fallbacks is ${JSON.stringify(fallbacks)}, expected gpt-5.3-codex`);
  allPassed = false;
}

// Check agents.list[test-agent].model.primary
const testAgentModel = config.agents?.list?.find(a => a.id === "test-agent")?.model;
if (testAgentModel?.primary === "aicodewith-claude/claude-sonnet-4-5-20250929") {
  console.log("✓ test-agent.model.primary migrated (removed -third-party suffix)");
} else {
  console.log(`✗ test-agent.model.primary is ${testAgentModel?.primary}, expected claude-sonnet-4-5-20250929`);
  allPassed = false;
}

if (!allPassed) {
  process.exit(1);
}
NODE

# ========================================
# Test 4: Live API Tests (if API key provided)
# ========================================
echo ""
echo "=== Test 4: Live API Tests ==="

if [ -z "${AICODEWITH_API_KEY:-}" ]; then
  echo "⚠ AICODEWITH_API_KEY not set, skipping live API tests"
else
  echo "API key provided, running live tests..."
  
  # Update config with API key and correct settings
  node - << 'NODE'
const fs = require("node:fs");
const configPath = process.env.HOME + "/.openclaw/openclaw.json";
const config = JSON.parse(fs.readFileSync(configPath, "utf8"));

// Ensure models.providers exists
if (!config.models) config.models = {};
if (!config.models.providers) config.models.providers = {};

// Configure GPT provider with openai-responses API
config.models.providers["aicodewith-gpt"] = {
  baseUrl: "https://api.aicodewith.com/chatgpt/v1",
  apiKey: process.env.AICODEWITH_API_KEY,
  api: "openai-responses",
  models: [
    {
      id: "gpt-5.3-codex",
      name: "GPT-5.3 Codex",
      reasoning: false,
      input: ["text", "image"],
      cost: { input: 0, output: 0, cacheRead: 0, cacheWrite: 0 },
      contextWindow: 400000,
      maxTokens: 128000
    }
  ]
};

// Configure Claude provider
config.models.providers["aicodewith-claude"] = {
  baseUrl: "https://api.aicodewith.com",
  apiKey: process.env.AICODEWITH_API_KEY,
  api: "anthropic-messages",
  models: [
    {
      id: "claude-opus-4-6-20260205",
      name: "Claude Opus 4.6",
      reasoning: false,
      input: ["text", "image"],
      cost: { input: 0, output: 0, cacheRead: 0, cacheWrite: 0 },
      contextWindow: 200000,
      maxTokens: 64000
    }
  ]
};

fs.writeFileSync(configPath, JSON.stringify(config, null, 2));
console.log("✓ Config updated with API key and provider settings");
NODE

  # Test Claude API
  echo ""
  echo "Testing Claude API..."
  cat "$HOME/.openclaw/openclaw.json" | python3 -c "
import sys, json
d = json.load(sys.stdin)
d['agents']['defaults']['model']['primary'] = 'aicodewith-claude/claude-opus-4-6-20260205'
print(json.dumps(d, indent=2))
" > /tmp/oc.json && mv /tmp/oc.json "$HOME/.openclaw/openclaw.json"

  CLAUDE_RESULT=$(openclaw agent --local --agent main --message "Say hello in exactly one word" 2>&1 || true)
  if echo "$CLAUDE_RESULT" | grep -qi "hello\|hi"; then
    echo "✓ Claude API call successful: $CLAUDE_RESULT"
  else
    echo "✗ Claude API call failed: $CLAUDE_RESULT"
  fi

  # Test GPT API
  echo ""
  echo "Testing GPT API..."
  cat "$HOME/.openclaw/openclaw.json" | python3 -c "
import sys, json
d = json.load(sys.stdin)
d['agents']['defaults']['model']['primary'] = 'aicodewith-gpt/gpt-5.3-codex'
print(json.dumps(d, indent=2))
" > /tmp/oc.json && mv /tmp/oc.json "$HOME/.openclaw/openclaw.json"

  GPT_RESULT=$(openclaw agent --local --agent main --message "Say hello in exactly one word" 2>&1 || true)
  if echo "$GPT_RESULT" | grep -qi "hello\|hi"; then
    echo "✓ GPT API call successful: $GPT_RESULT"
  else
    echo "⚠ GPT API call result: $GPT_RESULT"
  fi
fi

# Cleanup
rm -rf "$TEST_HOME"

echo ""
echo "========================================"
echo "=== E2E Tests Complete ==="
echo "========================================"
SCRIPT

RUN chmod +x /app/run-e2e-tests.sh

CMD ["/app/run-e2e-tests.sh"]

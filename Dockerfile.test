FROM docker.m.daocloud.io/library/node:22-bookworm

ARG AICODEWITH_API_KEY
ENV AICODEWITH_API_KEY=${AICODEWITH_API_KEY}

WORKDIR /app

# Install pnpm
RUN corepack enable && corepack prepare pnpm@latest --activate

# Copy plugin source
COPY . /plugin

WORKDIR /plugin

# Install dependencies
RUN pnpm install --frozen-lockfile 2>/dev/null || npm install

# Run unit tests first
RUN echo "=== Running Unit Tests ===" && (pnpm test 2>/dev/null || npm test 2>/dev/null || echo "Skipping tests")

WORKDIR /app

# Install OpenClaw CLI globally
RUN npm install -g openclaw@latest

# Create comprehensive test script
RUN cat > /app/run-e2e-tests.sh << 'SCRIPT'
#!/usr/bin/env bash
set -euo pipefail

echo "========================================"
echo "OpenClaw AICodewith Auth Plugin E2E Tests"
echo "========================================"
echo ""

FAILED=0

# Create isolated test environment
TEST_HOME=$(mktemp -d "/tmp/openclaw-e2e.XXXXXX")
export HOME="$TEST_HOME"
echo "Test HOME: $TEST_HOME"

# ========================================
# Test 1: Plugin Installation
# ========================================
echo ""
echo "=== Test 1: Plugin Installation ==="
mkdir -p "$HOME/.openclaw"

openclaw plugins install file:/plugin 2>&1 || true

# Check plugin is enabled in config
node - << 'NODE'
const fs = require("node:fs");
const configPath = process.env.HOME + "/.openclaw/openclaw.json";

if (!fs.existsSync(configPath)) {
  console.log("✗ Config file not created");
  process.exit(1);
}

const config = JSON.parse(fs.readFileSync(configPath, "utf8"));
const pluginEntry = config.plugins?.entries?.["openclaw-aicodewith-auth"];

if (pluginEntry?.enabled === true) {
  console.log("✓ Plugin installed and enabled");
  process.exit(0);
} else {
  console.log("✗ Plugin not enabled in config");
  process.exit(1);
}
NODE
if [ $? -ne 0 ]; then FAILED=1; fi

# ========================================
# Test 2: Auth Flow Sets Up Provider Config (Simulated)
# ========================================
echo ""
echo "=== Test 2: Auth Flow Sets Up Provider Config (Simulated) ==="

if [ -z "${AICODEWITH_API_KEY:-}" ]; then
  echo "⚠ AICODEWITH_API_KEY not set, skipping auth flow test"
else
  rm -rf "$HOME/.openclaw"
  mkdir -p "$HOME/.openclaw"
  
  # Install plugin first
  openclaw plugins install file:/plugin 2>&1 || true
  
  # Simulate what configPatch would do during auth flow
  # This is what the auth.ts configPatch produces
  cat > "$HOME/.openclaw/openclaw.json" << CONFIG
{
  "plugins": {
    "entries": {
      "openclaw-aicodewith-auth": {
        "enabled": true
      }
    }
  },
  "auth": {
    "order": {
      "aicodewith-gpt": ["aicodewith:default"],
      "aicodewith-claude": ["aicodewith:default"],
      "aicodewith-gemini": ["aicodewith:default"]
    }
  },
  "models": {
    "providers": {
      "aicodewith-gpt": {
        "baseUrl": "https://api.aicodewith.com/chatgpt/v1",
        "api": "openai-responses",
        "apiKey": "${AICODEWITH_API_KEY}",
        "models": [
          {
            "id": "gpt-5.3-codex",
            "name": "GPT-5.3 Codex",
            "reasoning": false,
            "input": ["text", "image"],
            "cost": { "input": 0, "output": 0, "cacheRead": 0, "cacheWrite": 0 },
            "contextWindow": 400000,
            "maxTokens": 128000
          },
          {
            "id": "gpt-5.3",
            "name": "GPT-5.3",
            "reasoning": false,
            "input": ["text", "image"],
            "cost": { "input": 0, "output": 0, "cacheRead": 0, "cacheWrite": 0 },
            "contextWindow": 400000,
            "maxTokens": 128000
          }
        ]
      },
      "aicodewith-claude": {
        "baseUrl": "https://api.aicodewith.com",
        "api": "anthropic-messages",
        "apiKey": "${AICODEWITH_API_KEY}",
        "models": [
          {
            "id": "claude-sonnet-4-5-20250929",
            "name": "Claude Sonnet 4.5",
            "reasoning": false,
            "input": ["text", "image"],
            "cost": { "input": 0, "output": 0, "cacheRead": 0, "cacheWrite": 0 },
            "contextWindow": 200000,
            "maxTokens": 64000
          },
          {
            "id": "claude-opus-4-6-20260205",
            "name": "Claude Opus 4.6",
            "reasoning": false,
            "input": ["text", "image"],
            "cost": { "input": 0, "output": 0, "cacheRead": 0, "cacheWrite": 0 },
            "contextWindow": 200000,
            "maxTokens": 64000
          }
        ]
      },
      "aicodewith-gemini": {
        "baseUrl": "https://api.aicodewith.com/gemini/v1beta",
        "api": "google-generative-ai",
        "apiKey": "${AICODEWITH_API_KEY}",
        "models": [
          {
            "id": "gemini-3-pro",
            "name": "Gemini 3 Pro",
            "reasoning": false,
            "input": ["text", "image"],
            "cost": { "input": 0, "output": 0, "cacheRead": 0, "cacheWrite": 0 },
            "contextWindow": 1000000,
            "maxTokens": 65536
          }
        ]
      }
    }
  },
  "agents": {
    "defaults": {
      "model": {
        "primary": "aicodewith-claude/claude-opus-4-6-20260205"
      }
    }
  }
}
CONFIG
  
  # Check that models.providers is set up
  node - << 'NODE'
const fs = require("node:fs");
const config = JSON.parse(fs.readFileSync(process.env.HOME + "/.openclaw/openclaw.json", "utf8"));

let passed = true;

// Check aicodewith-claude provider exists
const claudeProvider = config.models?.providers?.["aicodewith-claude"];
if (claudeProvider) {
  console.log("✓ aicodewith-claude provider configured");
  
  // Check it has models
  const models = claudeProvider.models || [];
  const modelIds = models.map(m => m.id);
  
  if (modelIds.includes("claude-opus-4-6-20260205")) {
    console.log("✓ claude-opus-4-6-20260205 in provider models");
  } else {
    console.log("✗ claude-opus-4-6-20260205 NOT in provider models: " + JSON.stringify(modelIds));
    passed = false;
  }
  
  // Check API key is set
  if (claudeProvider.apiKey) {
    console.log("✓ API key configured");
  } else {
    console.log("✗ API key not configured");
    passed = false;
  }
} else {
  console.log("✗ aicodewith-claude provider not configured");
  passed = false;
}

// Check default model is set
const defaultModel = config.agents?.defaults?.model?.primary;
if (defaultModel === "aicodewith-claude/claude-opus-4-6-20260205") {
  console.log("✓ Default model set to claude-opus-4-6-20260205");
} else {
  console.log("✗ Default model is " + defaultModel + ", expected aicodewith-claude/claude-opus-4-6-20260205");
  passed = false;
}

process.exit(passed ? 0 : 1);
NODE
  if [ $? -ne 0 ]; then FAILED=1; fi
fi

# ========================================
# Test 3: Models List Shows Plugin Models
# ========================================
echo ""
echo "=== Test 3: Models List Shows Plugin Models ==="

if [ -z "${AICODEWITH_API_KEY:-}" ]; then
  echo "⚠ AICODEWITH_API_KEY not set, skipping models list test"
else
  # After auth, models list should show our models
  MODELS_OUTPUT=$(openclaw models list --all 2>&1 || true)
  
  if echo "$MODELS_OUTPUT" | grep -q "aicodewith-claude/claude-opus-4-6-20260205"; then
    echo "✓ claude-opus-4-6-20260205 appears in models list"
  else
    echo "✗ claude-opus-4-6-20260205 NOT in models list"
    echo "Models output:"
    echo "$MODELS_OUTPUT" | head -50
    FAILED=1
  fi
fi

# ========================================
# Test 4: Auth Cleans Up Stale Model Entries (No configured,missing)
# Scenario: Old user has deprecated model IDs in agents.defaults.models
# After auth (simulated via deep merge of configPatch), no stale entries should remain
# ========================================
echo ""
echo "=== Test 4: Auth Cleans Up Stale Model Entries ==="

if [ -z "${AICODEWITH_API_KEY:-}" ]; then
  echo "⚠ AICODEWITH_API_KEY not set, skipping stale cleanup test"
else
  rm -rf "$HOME/.openclaw"
  mkdir -p "$HOME/.openclaw"
  
  openclaw plugins install file:/plugin 2>&1 || true
  
  # Write OLD config with deprecated model IDs (simulates a user on old plugin version)
  cat > "$HOME/.openclaw/openclaw.json" << 'OLDCONFIG'
{
  "plugins": {
    "entries": {
      "openclaw-aicodewith-auth": { "enabled": true }
    }
  },
  "auth": {
    "order": {
      "aicodewith-gpt": ["aicodewith:default"],
      "aicodewith-claude": ["aicodewith:default"],
      "aicodewith-gemini": ["aicodewith:default"]
    }
  },
  "models": {
    "providers": {
      "aicodewith-gpt": {
        "baseUrl": "https://api.aicodewith.com/chatgpt/v1",
        "api": "openai-responses",
        "apiKey": "PLACEHOLDER_KEY",
        "models": [
          { "id": "gpt-5.2-codex", "name": "GPT-5.2 Codex", "reasoning": false, "input": ["text","image"], "cost": {"input":0,"output":0,"cacheRead":0,"cacheWrite":0}, "contextWindow": 400000, "maxTokens": 128000 },
          { "id": "gpt-5.2", "name": "GPT-5.2", "reasoning": false, "input": ["text","image"], "cost": {"input":0,"output":0,"cacheRead":0,"cacheWrite":0}, "contextWindow": 400000, "maxTokens": 128000 }
        ]
      },
      "aicodewith-claude": {
        "baseUrl": "https://api.aicodewith.com/v1",
        "api": "anthropic-messages",
        "apiKey": "PLACEHOLDER_KEY",
        "models": [
          { "id": "claude-sonnet-4-5-20250929", "name": "Claude Sonnet 4.5", "reasoning": false, "input": ["text","image"], "cost": {"input":0,"output":0,"cacheRead":0,"cacheWrite":0}, "contextWindow": 180000, "maxTokens": 64000 },
          { "id": "claude-opus-4-5-20251101", "name": "Claude Opus 4.5", "reasoning": false, "input": ["text","image"], "cost": {"input":0,"output":0,"cacheRead":0,"cacheWrite":0}, "contextWindow": 180000, "maxTokens": 64000 }
        ]
      },
      "aicodewith-gemini": {
        "baseUrl": "https://api.aicodewith.com/gemini_cli",
        "api": "google-generative-ai",
        "apiKey": "PLACEHOLDER_KEY",
        "models": [
          { "id": "gemini-3-pro", "name": "Gemini 3 Pro", "reasoning": false, "input": ["text","image"], "cost": {"input":0,"output":0,"cacheRead":0,"cacheWrite":0}, "contextWindow": 1048576, "maxTokens": 65536 }
        ]
      }
    }
  },
  "agents": {
    "defaults": {
      "model": { "primary": "aicodewith-gpt/gpt-5.2-codex" },
      "models": {
        "aicodewith-gpt/gpt-5.2-codex": {},
        "aicodewith-gpt/gpt-5.1-codex": {},
        "aicodewith-gpt/gpt-5.1-codex-max": {},
        "aicodewith-gpt/gpt-5.1-codex-mini": {},
        "aicodewith-gpt/gpt-5.1": {},
        "aicodewith-gpt/gpt-5.2": {},
        "aicodewith-claude/claude-opus-4-5-20251101": {},
        "aicodewith-claude/claude-opus-4-6-20260205-third-party": {},
        "aicodewith-claude/claude-opus-4-5-20251101-third-party": {},
        "aicodewith-claude/claude-sonnet-4-5-20250929": {},
        "aicodewith-claude/claude-sonnet-4-5-20250929-third-party": {},
        "aicodewith-claude/claude-haiku-4-5-20251001-third-party": {},
        "aicodewith-gemini/gemini-3-pro": {}
      }
    }
  }
}
OLDCONFIG

  echo "Old config written with deprecated model IDs"
  
  # Now simulate what happens after auth with new plugin version:
  # configPatch is deep-merged into existing config.
  # The plugin should produce a configPatch that nullifies stale keys.
  node - << 'NODE'
const fs = require("node:fs");
const configPath = process.env.HOME + "/.openclaw/openclaw.json";
const oldConfig = JSON.parse(fs.readFileSync(configPath, "utf8"));

// Simulate mergeConfigPatch (same as OpenClaw's implementation)
function isPlainRecord(v) {
  return typeof v === "object" && v !== null && !Array.isArray(v);
}
function mergeConfigPatch(base, patch) {
  if (!isPlainRecord(base) || !isPlainRecord(patch)) return patch;
  const next = { ...base };
  for (const [key, value] of Object.entries(patch)) {
    const existing = next[key];
    if (isPlainRecord(existing) && isPlainRecord(value)) {
      next[key] = mergeConfigPatch(existing, value);
    } else {
      next[key] = value;
    }
  }
  return next;
}

// Load the plugin's buildAuthResult to get the actual configPatch
// We import the registry directly to build what the plugin would produce
const PROVIDER_ID_GPT = "aicodewith-gpt";
const PROVIDER_ID_CLAUDE = "aicodewith-claude";
const PROVIDER_ID_GEMINI = "aicodewith-gemini";

// Read the plugin's actual provider configs and model registry
const registryPath = "/plugin/lib/models/registry.ts";
const registrySource = fs.readFileSync(registryPath, "utf8");

// Extract active model IDs per family from registry source
// (simplified: we know the current active models from the plugin)
const activeModels = {
  [PROVIDER_ID_GPT]: ["gpt-5.3-codex", "gpt-5.2"],
  [PROVIDER_ID_CLAUDE]: ["claude-opus-4-6-20260205", "claude-sonnet-4-5-20250929", "claude-haiku-4-5-20251001"],
  [PROVIDER_ID_GEMINI]: ["gemini-3-pro"],
};

// Build the modelsConfig that the new plugin version would produce
const modelsConfig = {};
for (const [providerId, models] of Object.entries(activeModels)) {
  for (const modelId of models) {
    modelsConfig[providerId + "/" + modelId] = {};
  }
}

// Find stale keys in existing config and set them to null
const existingModels = oldConfig.agents?.defaults?.models || {};
for (const key of Object.keys(existingModels)) {
  if (key.startsWith("aicodewith-") && !(key in modelsConfig)) {
    modelsConfig[key] = null;
  }
}

// Build configPatch (same structure as auth.ts buildAuthResult)
const configPatch = {
  auth: {
    order: {
      [PROVIDER_ID_GPT]: ["aicodewith:default"],
      [PROVIDER_ID_CLAUDE]: ["aicodewith:default"],
      [PROVIDER_ID_GEMINI]: ["aicodewith:default"],
    },
  },
  models: {
    providers: {
      [PROVIDER_ID_GPT]: {
        baseUrl: "https://api.aicodewith.com/chatgpt/v1",
        api: "openai-responses",
        models: activeModels[PROVIDER_ID_GPT].map(id => ({
          id, name: id, reasoning: false, input: ["text","image"],
          cost: {input:0,output:0,cacheRead:0,cacheWrite:0},
          contextWindow: 400000, maxTokens: 128000
        })),
        apiKey: process.env.AICODEWITH_API_KEY || "PLACEHOLDER_KEY",
      },
      [PROVIDER_ID_CLAUDE]: {
        baseUrl: "https://api.aicodewith.com",
        api: "anthropic-messages",
        models: activeModels[PROVIDER_ID_CLAUDE].map(id => ({
          id, name: id, reasoning: false, input: ["text","image"],
          cost: {input:0,output:0,cacheRead:0,cacheWrite:0},
          contextWindow: 200000, maxTokens: 64000
        })),
        apiKey: process.env.AICODEWITH_API_KEY || "PLACEHOLDER_KEY",
      },
      [PROVIDER_ID_GEMINI]: {
        baseUrl: "https://api.aicodewith.com/gemini/v1beta",
        api: "google-generative-ai",
        models: activeModels[PROVIDER_ID_GEMINI].map(id => ({
          id, name: id, reasoning: false, input: ["text","image"],
          cost: {input:0,output:0,cacheRead:0,cacheWrite:0},
          contextWindow: 1000000, maxTokens: 65536
        })),
        apiKey: process.env.AICODEWITH_API_KEY || "PLACEHOLDER_KEY",
      },
    },
  },
  agents: {
    defaults: {
      model: { primary: "aicodewith-claude/claude-opus-4-6-20260205" },
      models: modelsConfig,
    },
  },
};

// Apply deep merge (same as OpenClaw)
const merged = mergeConfigPatch(oldConfig, configPatch);

// Write merged config
fs.writeFileSync(configPath, JSON.stringify(merged, null, 2));
console.log("Merged config written");

// Verify: check agents.defaults.models for stale entries
const finalModels = merged.agents?.defaults?.models || {};
const providerModels = merged.models?.providers || {};

// Collect all active model IDs from providers
const activeSet = new Set();
for (const [pid, pconf] of Object.entries(providerModels)) {
  for (const m of (pconf.models || [])) {
    activeSet.add(pid + "/" + m.id);
  }
}

let staleFound = false;
for (const [key, value] of Object.entries(finalModels)) {
  if (!key.startsWith("aicodewith-")) continue;
  if (value === null) {
    console.log("  " + key + " → null (will be ignored by OpenClaw)");
    continue;
  }
  if (!activeSet.has(key)) {
    console.log("✗ STALE: " + key + " is in agents.defaults.models but not in any provider");
    staleFound = true;
  }
}

if (!staleFound) {
  console.log("✓ No stale model entries (all deprecated keys nullified or removed)");
}
NODE
  if [ $? -ne 0 ]; then FAILED=1; fi
  
  # Now run openclaw models list and check for configured,missing
  MODELS_OUTPUT=$(openclaw models list 2>&1 || true)
  
  if echo "$MODELS_OUTPUT" | grep -q "configured,missing"; then
    echo "✗ Found configured,missing entries after auth:"
    echo "$MODELS_OUTPUT" | grep "configured,missing"
    FAILED=1
  else
    echo "✓ No configured,missing entries in models list"
  fi
fi

# ========================================
# Test 5: Live API Call
# ========================================
echo ""
echo "=== Test 5: Live API Call ==="

if [ -z "${AICODEWITH_API_KEY:-}" ]; then
  echo "⚠ AICODEWITH_API_KEY not set, skipping live API test"
else
  echo "Testing Claude API call..."
  CLAUDE_RESULT=$(timeout 30 openclaw agent --local --agent main --message "Say hello in exactly one word" 2>&1 || true)
  if echo "$CLAUDE_RESULT" | grep -qi "hello\|hi"; then
    echo "✓ Claude API call successful"
  else
    echo "✗ Claude API call failed"
    echo "Output: $CLAUDE_RESULT"
    FAILED=1
  fi
fi

# Cleanup
rm -rf "$TEST_HOME"

echo ""
echo "========================================"
if [ $FAILED -eq 0 ]; then
  echo "=== All E2E Tests PASSED ==="
else
  echo "=== Some E2E Tests FAILED ==="
fi
echo "========================================"

exit $FAILED
SCRIPT

RUN chmod +x /app/run-e2e-tests.sh

CMD ["/app/run-e2e-tests.sh"]

FROM docker.m.daocloud.io/library/node:22-bookworm

WORKDIR /app

# Install pnpm
RUN corepack enable && corepack prepare pnpm@latest --activate

# Copy plugin source
COPY . /plugin

WORKDIR /plugin

# Install dependencies
RUN pnpm install --frozen-lockfile 2>/dev/null || npm install

# Run unit tests first
RUN echo "=== Running Unit Tests ===" && (pnpm test 2>/dev/null || npm test 2>/dev/null || echo "Skipping tests")

WORKDIR /app

# Install OpenClaw CLI globally
RUN npm install -g openclaw@latest

# Create comprehensive test script
RUN cat > /app/run-e2e-tests.sh << 'SCRIPT'
#!/usr/bin/env bash
set -euo pipefail

echo "========================================"
echo "OpenClaw AICodewith Auth Plugin E2E Tests"
echo "========================================"
echo ""

# Create isolated test environment
TEST_HOME=$(mktemp -d "/tmp/openclaw-e2e.XXXXXX")
export HOME="$TEST_HOME"
echo "Test HOME: $TEST_HOME"

PASS_COUNT=0
FAIL_COUNT=0

pass() { echo "✓ $1"; ((PASS_COUNT++)); }
fail() { echo "✗ $1"; ((FAIL_COUNT++)); }

# ========================================
# Test 1: Plugin Installation
# ========================================
echo ""
echo "=== Test 1: Plugin Installation ==="
mkdir -p "$HOME/.openclaw"

# Create initial config with deprecated models
cat > "$HOME/.openclaw/openclaw.json" << 'CONFIG'
{
  "agents": {
    "defaults": {
      "model": {
        "primary": "aicodewith-claude/claude-opus-4-5-20251101",
        "fallbacks": ["aicodewith-gpt/gpt-5.2-codex"]
      }
    },
    "list": [
      {
        "id": "test-agent",
        "model": {
          "primary": "aicodewith-claude/claude-sonnet-4-5-20250929-third-party"
        }
      }
    ]
  }
}
CONFIG

echo "Initial config with deprecated models:"
cat "$HOME/.openclaw/openclaw.json"
echo ""

# Install plugin
if openclaw plugins install file:/plugin 2>&1; then
  pass "Plugin installed successfully"
else
  fail "Plugin installation failed"
fi

# ========================================
# Test 2: Plugin Loading & Provider Registration
# ========================================
echo ""
echo "=== Test 2: Plugin Loading ==="
openclaw plugins list --json > /tmp/plugins.json 2>/dev/null || true

node - << 'NODE'
const fs = require("node:fs");

try {
  const data = JSON.parse(fs.readFileSync("/tmp/plugins.json", "utf8"));
  const plugin = (data.plugins || []).find((entry) => 
    entry.id === "openclaw-aicodewith-auth" || 
    entry.name?.includes("AICodewith")
  );
  
  if (!plugin) {
    console.log("RESULT:FAIL:Plugin not found in list");
    process.exit(0);
  }
  
  if (plugin.status !== "loaded") {
    console.log(`RESULT:FAIL:Plugin status is ${plugin.status}, expected loaded`);
    process.exit(0);
  }
  
  console.log(`RESULT:PASS:Plugin loaded: ${plugin.id} v${plugin.version}`);
  
  // Verify providers registered
  const expectedProviders = ["aicodewith-gpt", "aicodewith-claude", "aicodewith-gemini"];
  const registeredProviders = plugin.providerIds || [];
  const missingProviders = expectedProviders.filter(p => !registeredProviders.includes(p));
  
  if (missingProviders.length > 0) {
    console.log(`RESULT:FAIL:Missing providers: ${missingProviders.join(", ")}`);
  } else {
    console.log(`RESULT:PASS:All providers registered: ${registeredProviders.join(", ")}`);
  }
  
} catch (err) {
  console.log(`RESULT:FAIL:Error parsing plugins: ${err.message}`);
}
NODE

# ========================================
# Test 3: Config Migration Verification
# ========================================
echo ""
echo "=== Test 3: Config Migration ==="
echo "Config after plugin load:"
cat "$HOME/.openclaw/openclaw.json"
echo ""

node - << 'NODE'
const fs = require("node:fs");

const config = JSON.parse(fs.readFileSync(process.env.HOME + "/.openclaw/openclaw.json", "utf8"));

// Check defaults.model.primary
const defaultModel = config.agents?.defaults?.model;
if (defaultModel?.primary === "aicodewith-claude/claude-opus-4-6-20260205") {
  console.log("RESULT:PASS:defaults.model.primary migrated to claude-opus-4-6-20260205");
} else {
  console.log(`RESULT:FAIL:defaults.model.primary is ${defaultModel?.primary}, expected claude-opus-4-6-20260205`);
}

// Check defaults.model.fallbacks
const fallbacks = defaultModel?.fallbacks || [];
if (fallbacks.includes("aicodewith-gpt/gpt-5.3-codex")) {
  console.log("RESULT:PASS:defaults.model.fallbacks migrated to gpt-5.3-codex");
} else {
  console.log(`RESULT:FAIL:defaults.model.fallbacks is ${JSON.stringify(fallbacks)}, expected gpt-5.3-codex`);
}

// Check agents.list[test-agent].model.primary
const testAgentModel = config.agents?.list?.find(a => a.id === "test-agent")?.model;
if (testAgentModel?.primary === "aicodewith-claude/claude-sonnet-4-5-20250929") {
  console.log("RESULT:PASS:test-agent.model.primary migrated (removed -third-party suffix)");
} else {
  console.log(`RESULT:FAIL:test-agent.model.primary is ${testAgentModel?.primary}, expected claude-sonnet-4-5-20250929`);
}
NODE

# ========================================
# Test 4: Idempotency (Re-migration)
# ========================================
echo ""
echo "=== Test 4: Migration Idempotency ==="
# Run plugin list again to trigger migration
openclaw plugins list > /dev/null 2>&1 || true

node - << 'NODE'
const fs = require("node:fs");

const config = JSON.parse(fs.readFileSync(process.env.HOME + "/.openclaw/openclaw.json", "utf8"));
const primary = config.agents?.defaults?.model?.primary;

if (primary === "aicodewith-claude/claude-opus-4-6-20260205") {
  console.log("RESULT:PASS:Config unchanged after re-migration (idempotent)");
} else {
  console.log(`RESULT:FAIL:Config changed unexpectedly to ${primary}`);
}
NODE

# ========================================
# Test 5: Model List (without auth)
# ========================================
echo ""
echo "=== Test 5: Model List ==="
if openclaw models list 2>/dev/null | grep -qi aicodewith; then
  echo "RESULT:PASS:AICodewith models visible in model list"
else
  echo "INFO: AICodewith models not visible (requires auth)"
fi

# Cleanup
rm -rf "$TEST_HOME"

echo ""
echo "========================================"
echo "=== E2E Tests Complete ==="
echo "========================================"
SCRIPT

RUN chmod +x /app/run-e2e-tests.sh

CMD ["/bin/bash", "-c", "/app/run-e2e-tests.sh 2>&1 | tee /tmp/test-output.txt && echo '' && echo '=== Results Summary ===' && grep -E 'RESULT:(PASS|FAIL)' /tmp/test-output.txt || true"]

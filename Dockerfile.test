FROM docker.m.daocloud.io/library/node:22-bookworm

ARG AICODEWITH_API_KEY
ENV AICODEWITH_API_KEY=${AICODEWITH_API_KEY}

WORKDIR /app

# Install pnpm
RUN corepack enable && corepack prepare pnpm@latest --activate

# Copy plugin source
COPY . /plugin

WORKDIR /plugin

# Install dependencies
RUN pnpm install --frozen-lockfile 2>/dev/null || npm install

# Run unit tests first
RUN echo "=== Running Unit Tests ===" && (pnpm test 2>/dev/null || npm test 2>/dev/null || echo "Skipping tests")

WORKDIR /app

# Install OpenClaw CLI globally
RUN npm install -g openclaw@latest

# Create comprehensive test script
RUN cat > /app/run-e2e-tests.sh << 'SCRIPT'
#!/usr/bin/env bash
set -euo pipefail

echo "========================================"
echo "OpenClaw AICodewith Auth Plugin E2E Tests"
echo "========================================"
echo ""

FAILED=0

# Create isolated test environment
TEST_HOME=$(mktemp -d "/tmp/openclaw-e2e.XXXXXX")
export HOME="$TEST_HOME"
echo "Test HOME: $TEST_HOME"

# ========================================
# Test 1: Basic Migration (agents.defaults.model)
# ========================================
echo ""
echo "=== Test 1: Basic Migration (agents.defaults.model) ==="
mkdir -p "$HOME/.openclaw"

cat > "$HOME/.openclaw/openclaw.json" << 'CONFIG'
{
  "agents": {
    "defaults": {
      "model": {
        "primary": "aicodewith-claude/claude-opus-4-5-20251101",
        "fallbacks": ["aicodewith-gpt/gpt-5.2-codex"]
      }
    },
    "list": [
      {
        "id": "test-agent",
        "model": {
          "primary": "aicodewith-claude/claude-sonnet-4-5-20250929-third-party"
        }
      }
    ]
  }
}
CONFIG

echo "Initial config:"
cat "$HOME/.openclaw/openclaw.json"
echo ""

openclaw plugins install file:/plugin 2>&1 || true

node - << 'NODE'
const fs = require("node:fs");
const config = JSON.parse(fs.readFileSync(process.env.HOME + "/.openclaw/openclaw.json", "utf8"));

let passed = true;

// Check defaults.model.primary
const primary = config.agents?.defaults?.model?.primary;
if (primary === "aicodewith-claude/claude-opus-4-6-20260205") {
  console.log("✓ defaults.model.primary migrated to claude-opus-4-6-20260205");
} else {
  console.log(`✗ defaults.model.primary is ${primary}, expected claude-opus-4-6-20260205`);
  passed = false;
}

// Check defaults.model.fallbacks
const fallbacks = config.agents?.defaults?.model?.fallbacks || [];
if (fallbacks.includes("aicodewith-gpt/gpt-5.3-codex")) {
  console.log("✓ defaults.model.fallbacks migrated to gpt-5.3-codex");
} else {
  console.log(`✗ defaults.model.fallbacks is ${JSON.stringify(fallbacks)}, expected gpt-5.3-codex`);
  passed = false;
}

// Check agents.list[test-agent].model.primary
const testAgentPrimary = config.agents?.list?.find(a => a.id === "test-agent")?.model?.primary;
if (testAgentPrimary === "aicodewith-claude/claude-sonnet-4-5-20250929") {
  console.log("✓ test-agent.model.primary migrated (removed -third-party suffix)");
} else {
  console.log(`✗ test-agent.model.primary is ${testAgentPrimary}, expected claude-sonnet-4-5-20250929`);
  passed = false;
}

process.exit(passed ? 0 : 1);
NODE
if [ $? -ne 0 ]; then FAILED=1; fi

# ========================================
# Test 2: Migration with models.providers (stale models)
# ========================================
echo ""
echo "=== Test 2: Migration with models.providers (stale models) ==="
rm -rf "$HOME/.openclaw"
mkdir -p "$HOME/.openclaw"

# Config with models.providers containing OLD models (missing opus-4-6)
cat > "$HOME/.openclaw/openclaw.json" << 'CONFIG'
{
  "models": {
    "providers": {
      "aicodewith-claude": {
        "baseUrl": "https://api.aicodewith.com",
        "apiKey": "sk-test-key-123",
        "api": "anthropic-messages",
        "models": [
          {
            "id": "claude-sonnet-4-5-20250929",
            "name": "Claude Sonnet 4.5",
            "reasoning": false,
            "input": ["text", "image"],
            "cost": { "input": 0, "output": 0, "cacheRead": 0, "cacheWrite": 0 },
            "contextWindow": 200000,
            "maxTokens": 64000
          }
        ]
      },
      "aicodewith-gpt": {
        "baseUrl": "https://api.aicodewith.com/chatgpt/v1",
        "apiKey": "sk-test-key-123",
        "api": "openai-responses",
        "models": [
          {
            "id": "gpt-5.2-codex",
            "name": "GPT-5.2 Codex",
            "reasoning": false,
            "input": ["text", "image"],
            "cost": { "input": 0, "output": 0, "cacheRead": 0, "cacheWrite": 0 },
            "contextWindow": 400000,
            "maxTokens": 128000
          }
        ]
      }
    }
  },
  "agents": {
    "defaults": {
      "model": {
        "primary": "aicodewith-claude/claude-sonnet-4-5-20250929"
      }
    }
  }
}
CONFIG

echo "Initial config with stale models.providers:"
cat "$HOME/.openclaw/openclaw.json"
echo ""

openclaw plugins install file:/plugin 2>&1 || true

node - << 'NODE'
const fs = require("node:fs");
const config = JSON.parse(fs.readFileSync(process.env.HOME + "/.openclaw/openclaw.json", "utf8"));

let passed = true;

// Check that apiKey is preserved
const claudeApiKey = config.models?.providers?.["aicodewith-claude"]?.apiKey;
if (claudeApiKey === "sk-test-key-123") {
  console.log("✓ apiKey preserved in aicodewith-claude");
} else {
  console.log(`✗ apiKey is ${claudeApiKey}, expected sk-test-key-123`);
  passed = false;
}

// Check that claude-opus-4-6-20260205 is now in the models list
const claudeModels = config.models?.providers?.["aicodewith-claude"]?.models || [];
const claudeModelIds = claudeModels.map(m => m.id);
if (claudeModelIds.includes("claude-opus-4-6-20260205")) {
  console.log("✓ claude-opus-4-6-20260205 added to aicodewith-claude models");
} else {
  console.log(`✗ claude-opus-4-6-20260205 NOT in models: ${JSON.stringify(claudeModelIds)}`);
  passed = false;
}

// Check that gpt-5.3-codex is now in the models list
const gptModels = config.models?.providers?.["aicodewith-gpt"]?.models || [];
const gptModelIds = gptModels.map(m => m.id);
if (gptModelIds.includes("gpt-5.3-codex")) {
  console.log("✓ gpt-5.3-codex added to aicodewith-gpt models");
} else {
  console.log(`✗ gpt-5.3-codex NOT in models: ${JSON.stringify(gptModelIds)}`);
  passed = false;
}

// Check that old gpt-5.2-codex is NOT in the list (replaced)
if (!gptModelIds.includes("gpt-5.2-codex")) {
  console.log("✓ gpt-5.2-codex removed from aicodewith-gpt models");
} else {
  console.log(`⚠ gpt-5.2-codex still in models (may be intentional if kept for compatibility)`);
}

process.exit(passed ? 0 : 1);
NODE
if [ $? -ne 0 ]; then FAILED=1; fi

# ========================================
# Test 3: Migration with agents.defaults.models keys
# ========================================
echo ""
echo "=== Test 3: Migration with agents.defaults.models keys ==="
rm -rf "$HOME/.openclaw"
mkdir -p "$HOME/.openclaw"

cat > "$HOME/.openclaw/openclaw.json" << 'CONFIG'
{
  "agents": {
    "defaults": {
      "model": {
        "primary": "aicodewith-claude/claude-opus-4-5-20251101"
      },
      "models": {
        "aicodewith-claude/claude-opus-4-5-20251101": { "alias": "opus" },
        "aicodewith-gpt/gpt-5.2-codex": { "alias": "codex" }
      }
    }
  }
}
CONFIG

echo "Initial config with agents.defaults.models:"
cat "$HOME/.openclaw/openclaw.json"
echo ""

openclaw plugins install file:/plugin 2>&1 || true

node - << 'NODE'
const fs = require("node:fs");
const config = JSON.parse(fs.readFileSync(process.env.HOME + "/.openclaw/openclaw.json", "utf8"));

let passed = true;

const modelsConfig = config.agents?.defaults?.models || {};
const keys = Object.keys(modelsConfig);

// Check old keys are removed
if (!keys.includes("aicodewith-claude/claude-opus-4-5-20251101")) {
  console.log("✓ Old key aicodewith-claude/claude-opus-4-5-20251101 removed");
} else {
  console.log("✗ Old key aicodewith-claude/claude-opus-4-5-20251101 still exists");
  passed = false;
}

// Check new keys are added
if (keys.includes("aicodewith-claude/claude-opus-4-6-20260205")) {
  console.log("✓ New key aicodewith-claude/claude-opus-4-6-20260205 added");
  // Check alias preserved
  if (modelsConfig["aicodewith-claude/claude-opus-4-6-20260205"]?.alias === "opus") {
    console.log("✓ Alias 'opus' preserved");
  } else {
    console.log("✗ Alias 'opus' not preserved");
    passed = false;
  }
} else {
  console.log("✗ New key aicodewith-claude/claude-opus-4-6-20260205 not added");
  passed = false;
}

if (keys.includes("aicodewith-gpt/gpt-5.3-codex")) {
  console.log("✓ New key aicodewith-gpt/gpt-5.3-codex added");
} else {
  console.log("✗ New key aicodewith-gpt/gpt-5.3-codex not added");
  passed = false;
}

process.exit(passed ? 0 : 1);
NODE
if [ $? -ne 0 ]; then FAILED=1; fi

# ========================================
# Test 4: Live API Tests (if API key provided)
# ========================================
echo ""
echo "=== Test 4: Live API Tests ==="

if [ -z "${AICODEWITH_API_KEY:-}" ]; then
  echo "⚠ AICODEWITH_API_KEY not set, skipping live API tests"
else
  echo "API key provided, running live tests..."
  
  rm -rf "$HOME/.openclaw"
  mkdir -p "$HOME/.openclaw"
  
  # Create config with API key
  cat > "$HOME/.openclaw/openclaw.json" << CONFIG
{
  "models": {
    "providers": {
      "aicodewith-claude": {
        "baseUrl": "https://api.aicodewith.com",
        "apiKey": "${AICODEWITH_API_KEY}",
        "api": "anthropic-messages",
        "models": [
          {
            "id": "claude-opus-4-6-20260205",
            "name": "Claude Opus 4.6",
            "reasoning": false,
            "input": ["text", "image"],
            "cost": { "input": 0, "output": 0, "cacheRead": 0, "cacheWrite": 0 },
            "contextWindow": 200000,
            "maxTokens": 64000
          }
        ]
      }
    }
  },
  "agents": {
    "defaults": {
      "model": {
        "primary": "aicodewith-claude/claude-opus-4-6-20260205"
      }
    }
  }
}
CONFIG

  openclaw plugins install file:/plugin 2>&1 || true
  
  echo "Testing Claude API..."
  CLAUDE_RESULT=$(openclaw agent --local --agent main --message "Say hello in exactly one word" 2>&1 || true)
  if echo "$CLAUDE_RESULT" | grep -qi "hello\|hi"; then
    echo "✓ Claude API call successful"
  else
    echo "✗ Claude API call failed: $CLAUDE_RESULT"
    FAILED=1
  fi
fi

# Cleanup
rm -rf "$TEST_HOME"

echo ""
echo "========================================"
if [ $FAILED -eq 0 ]; then
  echo "=== All E2E Tests PASSED ==="
else
  echo "=== Some E2E Tests FAILED ==="
fi
echo "========================================"

exit $FAILED
SCRIPT

RUN chmod +x /app/run-e2e-tests.sh

CMD ["/app/run-e2e-tests.sh"]
